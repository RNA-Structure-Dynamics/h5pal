$(document).ready(function () {
	var json_event_list=[{"y": 808, "x": 528}, {"y": 632, "x": 688}, {"y": 672, "x": 736}, {"y": 392, "x": 1168}, {"y": 280, "x": 1264}, {"y": 400, "x": 1280}, {"y": 320, "x": 1472}, {"y": 616, "x": 656}, {"y": 296, "x": 1392}, {"y": 280, "x": 1392}, {"y": 304, "x": 1344}, {"y": 304, "x": 1344}, {"y": 1136, "x": 1216}, {"y": 1072, "x": 1536}, {"y": 1048, "x": 1488}, {"y": 1104, "x": 1280}, {"y": 1088, "x": 1344}, {"y": 408, "x": 432}, {"y": 1296, "x": 704}, {"y": 1080, "x": 720}, {"y": 1152, "x": 672}, {"y": 1120, "x": 512}, {"y": 1136, "x": 480}, {"y": 1160, "x": 432}, {"y": 296, "x": 560}, {"y": 1120, "x": 1376}, {"y": 1048, "x": 1328}, {"y": 264, "x": 1296}, {"y": 264, "x": 1296}, {"y": 264, "x": 1296}, {"y": 320, "x": 768}, {"y": 376, "x": 1328}];
	var map={
		name:"Yu_Hang_inns_seperate_rooms",
		pixelWidth:32,
		pixelHeight:15,
		pixelOffsetX:10,
		pixelOffsetY:31,
		barrierList:[[33, -5], [33, -6], [34, -6], [33, -3], [33, -4], [34, -5], [35, -6], [36, -6], [56, -26], [56, -27], [57, -27], [33, -1], [33, -2], [34, -2], [37, -5], [37, -6], [38, -6], [56, -24], [56, -25], [57, -25], [57, -26], [58, -26], [58, -27], [59, -27], [33, 1], [33, 0], [34, -1], [39, -5], [39, -6], [40, -6], [56, -22], [56, -23], [58, -25], [59, -25], [59, -26], [60, -26], [60, -27], [61, -27], [33, 3], [33, 2], [41, -6], [42, -6], [56, -20], [56, -21], [57, -22], [60, -25], [62, -27], [63, -27], [33, 5], [33, 4], [43, -5], [43, -6], [44, -6], [56, -18], [56, -19], [58, -21], [64, -27], [65, -27], [33, 7], [33, 6], [43, -4], [44, -4], [44, -5], [45, -5], [45, -6], [46, -6], [56, -16], [56, -17], [58, -19], [66, -26], [66, -27], [67, -27], [33, 9], [33, 8], [34, 8], [39, 3], [41, 1], [45, -4], [46, -4], [46, -5], [47, -6], [48, -6], [56, -14], [56, -15], [57, -15], [66, -25], [67, -25], [67, -26], [68, -26], [68, -27], [69, -27], [33, 10], [34, 10], [34, 9], [41, 3], [49, -5], [49, -6], [57, -14], [58, -14], [67, -23], [68, -25], [69, -25], [69, -26], [70, -26], [70, -27], [71, -27], [35, 10], [36, 10], [41, 5], [41, 4], [42, 4], [42, 3], [43, 3], [49, -3], [49, -4], [59, -14], [60, -14], [65, -19], [70, -24], [70, -25], [71, -25], [71, -26], [37, 10], [38, 10], [42, 5], [43, 5], [43, 4], [49, -1], [49, -2], [60, -12], [60, -13], [65, -17], [65, -18], [70, -23], [71, -23], [71, -24], [38, 12], [38, 11], [42, 7], [49, 1], [49, 0], [61, -12], [62, -12], [63, -13], [63, -14], [64, -14], [65, -15], [65, -16], [68, -18], [68, -19], [71, -21], [71, -22], [39, 12], [40, 12], [41, 11], [41, 10], [42, 10], [49, 3], [49, 2], [63, -12], [65, -14], [66, -14], [66, -15], [67, -15], [68, -17], [71, -19], [71, -20], [41, 12], [43, 10], [44, 10], [48, 6], [48, 5], [49, 5], [49, 4], [67, -14], [68, -14], [68, -15], [69, -15], [71, -17], [71, -18], [45, 10], [46, 10], [48, 8], [48, 7], [49, 7], [49, 6], [69, -14], [70, -14], [70, -15], [71, -15], [71, -16], [47, 10], [48, 10], [48, 9], [49, 9], [49, 8], [71, -14], [49, 10], [57, 15], [58, 14], [57, 17], [57, 16], [59, 14], [60, 14], [57, 19], [57, 18], [59, 17], [59, 16], [60, 16], [61, 14], [62, 14], [57, 21], [57, 20], [59, 19], [59, 18], [60, 17], [61, 17], [61, 16], [62, 16], [63, 14], [64, 14], [81, -3], [57, 23], [57, 22], [59, 21], [59, 20], [60, 20], [60, 19], [61, 19], [62, 18], [62, 17], [63, 17], [63, 16], [64, 16], [65, 14], [66, 14], [81, -1], [81, -2], [82, -2], [82, -3], [83, -3], [57, 25], [57, 24], [59, 23], [59, 22], [60, 22], [60, 21], [61, 21], [61, 20], [62, 20], [62, 19], [63, 19], [63, 18], [64, 18], [64, 17], [65, 17], [65, 16], [66, 16], [67, 14], [68, 14], [81, 1], [81, 0], [82, -1], [84, -3], [85, -3], [57, 27], [57, 26], [59, 25], [59, 24], [61, 23], [61, 22], [62, 22], [62, 21], [63, 21], [63, 20], [64, 20], [64, 19], [65, 19], [65, 18], [66, 18], [67, 16], [68, 16], [69, 14], [70, 14], [81, 3], [81, 2], [86, -3], [87, -3], [57, 29], [57, 28], [59, 27], [59, 26], [61, 25], [61, 24], [62, 24], [62, 23], [63, 23], [63, 22], [64, 22], [64, 21], [65, 21], [65, 20], [66, 19], [67, 18], [68, 18], [69, 16], [70, 16], [71, 15], [71, 14], [72, 14], [81, 5], [81, 4], [88, -3], [89, -3], [58, 30], [59, 29], [59, 28], [61, 27], [61, 26], [62, 25], [63, 25], [63, 24], [65, 22], [69, 18], [70, 18], [70, 17], [71, 17], [71, 16], [72, 16], [72, 15], [73, 15], [73, 14], [81, 7], [81, 6], [82, 6], [90, -2], [90, -3], [91, -3], [59, 31], [59, 30], [61, 29], [61, 28], [62, 27], [71, 18], [72, 18], [72, 17], [73, 17], [73, 16], [81, 9], [81, 8], [82, 8], [82, 7], [90, -1], [91, -1], [91, -2], [92, -2], [92, -3], [93, -3], [60, 32], [60, 31], [61, 31], [61, 30], [62, 30], [62, 29], [71, 21], [72, 20], [72, 19], [73, 19], [73, 18], [74, 18], [81, 10], [82, 10], [82, 9], [92, -1], [93, -1], [93, -2], [94, -2], [94, -3], [95, -3], [61, 32], [62, 32], [62, 31], [63, 31], [63, 30], [72, 21], [73, 21], [73, 20], [74, 20], [74, 19], [75, 19], [75, 18], [76, 18], [83, 10], [84, 10], [90, 3], [94, -1], [95, -1], [95, -2], [96, -2], [96, -3], [63, 32], [64, 32], [64, 31], [73, 23], [73, 22], [74, 22], [74, 21], [75, 21], [75, 20], [76, 20], [76, 19], [85, 10], [86, 10], [92, 4], [92, 3], [93, 3], [96, 0], [96, -1], [65, 33], [65, 32], [74, 24], [74, 23], [75, 23], [75, 22], [76, 22], [76, 21], [86, 12], [86, 11], [92, 5], [93, 5], [93, 4], [94, 4], [94, 3], [95, 3], [96, 2], [96, 1], [65, 34], [66, 34], [74, 25], [75, 25], [75, 24], [76, 24], [76, 23], [87, 12], [88, 12], [89, 11], [89, 10], [90, 10], [94, 5], [95, 5], [95, 4], [96, 4], [96, 3], [67, 34], [68, 34], [69, 33], [69, 32], [70, 32], [75, 27], [75, 26], [76, 26], [76, 25], [89, 12], [91, 10], [92, 10], [96, 6], [96, 5], [69, 34], [71, 32], [72, 32], [76, 28], [76, 27], [93, 10], [94, 10], [96, 8], [96, 7], [73, 32], [74, 32], [76, 30], [76, 29], [95, 10], [96, 10], [96, 9], [75, 32], [76, 32], [76, 31], [103, 19], [103, 18], [104, 18], [103, 21], [103, 20], [104, 19], [105, 18], [106, 18], [103, 23], [103, 22], [107, 18], [108, 18], [85, 43], [103, 25], [103, 24], [109, 18], [110, 18], [85, 45], [85, 44], [86, 44], [86, 43], [87, 43], [103, 27], [103, 26], [111, 18], [112, 18], [85, 47], [85, 46], [87, 44], [88, 43], [89, 43], [103, 29], [103, 28], [112, 20], [112, 19], [113, 19], [113, 18], [114, 18], [85, 49], [85, 48], [86, 48], [86, 47], [87, 47], [89, 45], [89, 44], [90, 44], [90, 43], [91, 43], [103, 31], [103, 30], [104, 30], [113, 20], [114, 20], [114, 19], [115, 19], [115, 18], [116, 18], [85, 51], [85, 50], [86, 50], [86, 49], [87, 49], [87, 48], [90, 45], [91, 45], [91, 44], [92, 43], [93, 43], [104, 31], [105, 31], [110, 26], [110, 25], [111, 25], [115, 20], [117, 18], [118, 18], [85, 53], [85, 52], [87, 50], [93, 45], [93, 44], [94, 44], [94, 43], [95, 43], [106, 31], [107, 31], [110, 27], [111, 27], [111, 26], [112, 26], [112, 25], [118, 20], [118, 19], [85, 55], [85, 54], [86, 54], [86, 53], [94, 45], [95, 45], [95, 44], [96, 43], [97, 43], [108, 32], [108, 31], [111, 28], [112, 27], [113, 26], [118, 22], [118, 21], [85, 57], [85, 56], [86, 56], [86, 55], [97, 44], [98, 44], [98, 43], [99, 43], [108, 33], [109, 33], [111, 31], [118, 24], [118, 23], [85, 59], [85, 58], [86, 57], [87, 57], [93, 51], [93, 50], [94, 50], [99, 44], [100, 44], [100, 43], [110, 33], [111, 33], [111, 32], [112, 31], [113, 31], [118, 26], [118, 25], [85, 61], [85, 60], [86, 59], [88, 57], [89, 57], [93, 52], [94, 52], [94, 51], [95, 51], [95, 50], [100, 46], [100, 45], [114, 31], [115, 31], [118, 28], [118, 27], [86, 61], [87, 61], [90, 57], [95, 52], [100, 48], [100, 47], [116, 31], [117, 31], [118, 30], [118, 29], [88, 61], [89, 61], [93, 57], [100, 50], [100, 49], [118, 31], [90, 61], [91, 61], [94, 57], [95, 57], [99, 53], [99, 52], [100, 52], [100, 51], [92, 61], [93, 61], [96, 57], [97, 57], [99, 55], [99, 54], [100, 54], [100, 53], [94, 61], [95, 61], [98, 57], [99, 57], [99, 56], [100, 56], [100, 55], [96, 61], [97, 61], [100, 57], [101, 57], [98, 61], [99, 61], [102, 57], [103, 57], [100, 61], [101, 61], [102, 61], [103, 61]],
		occlusionList:[[31, -5, 131], [32, -4, 204], [32, -5, 202], [35, -7, 42], [33, -3, 207], [33, -4, 133], [35, -6, 43], [36, -6, 45], [36, -7, 44], [37, -7, 88], [54, -24, 33], [54, -25, 32], [55, -25, 34], [34, -2, 138], [34, -3, 137], [37, -5, 46], [37, -6, 93], [38, -6, 90], [40, -8, 169], [55, -23, 36], [55, -24, 35], [56, -24, 37], [38, -5, 94], [39, -5, 92], [40, -6, 172], [40, -7, 170], [41, -7, 173], [41, -8, 171], [42, -8, 171], [56, -22, 39], [56, -23, 38], [57, -23, 40], [31, 5, 131], [41, -5, 176], [41, -6, 174], [42, -6, 177], [42, -7, 173], [54, -18, 131], [57, -21, 236], [57, -22, 240], [58, -22, 237], [64, -28, 219], [32, 6, 134], [32, 5, 133], [37, 1, 82], [39, -1, 71], [42, -4, 183], [42, -5, 180], [46, -8, 101], [46, -9, 101], [54, -16, 4], [54, -17, 135], [55, -17, 204], [55, -18, 202], [57, -19, 233], [57, -20, 232], [58, -20, 234], [58, -21, 238], [64, -27, 220], [65, -27, 222], [65, -28, 221], [66, -29, 211], [67, -29, 48], [68, -30, 101], [31, 8, 4], [32, 8, 1], [33, 7, 134], [33, 6, 133], [37, 2, 77], [38, 2, 78], [39, 1, 211], [40, 0, 73], [40, -1, 72], [46, -6, 101], [46, -7, 101], [47, -7, 28], [47, -8, 28], [55, -15, 7], [55, -16, 1], [56, -16, 1], [56, -17, 133], [58, -19, 235], [62, -22, 131], [65, -25, 230], [65, -26, 224], [66, -26, 226], [66, -27, 225], [67, -27, 231], [67, -28, 212], [68, -28, 101], [68, -29, 101], [69, -29, 28], [69, -30, 108], [32, 9, 7], [33, 9, 2], [33, 8, 1], [34, 8, 1], [34, 7, 137], [38, 3, 79], [39, 3, 81], [39, 2, 80], [40, 2, 212], [40, 1, 74], [41, 1, 76], [41, 0, 75], [46, -4, 101], [46, -5, 101], [47, -5, 28], [47, -6, 28], [48, -6, 29], [48, -7, 29], [56, -14, 9], [56, -15, 2], [57, -15, 2], [57, -16, 3], [58, -16, 12], [58, -17, 20], [62, -20, 132], [62, -21, 132], [63, -21, 134], [63, -22, 133], [65, -24, 83], [66, -24, 84], [66, -25, 227], [67, -25, 203], [67, -26, 48], [68, -26, 229], [68, -27, 228], [69, -27, 28], [69, -28, 28], [70, -28, 29], [70, -29, 109], [33, 10, 9], [34, 10, 5], [34, 9, 2], [35, 9, 2], [35, 8, 3], [36, 8, 12], [36, 7, 20], [40, 4, 50], [40, 3, 213], [41, 3, 214], [41, 2, 49], [42, 2, 52], [46, -2, 101], [46, -3, 101], [47, -3, 28], [47, -4, 28], [48, -4, 29], [48, -5, 29], [49, -5, 30], [49, -6, 30], [57, -14, 5], [58, -14, 5], [58, -15, 6], [59, -15, 14], [59, -16, 13], [60, -16, 16], [60, -17, 20], [62, -18, 132], [62, -19, 132], [63, -19, 134], [63, -20, 134], [64, -20, 134], [64, -21, 133], [65, -21, 132], [65, -22, 131], [66, -22, 133], [66, -23, 85], [67, -23, 87], [67, -24, 86], [68, -24, 101], [68, -25, 101], [69, -25, 28], [69, -26, 28], [70, -26, 29], [70, -27, 29], [71, -27, 30], [71, -28, 110], [35, 10, 5], [36, 10, 5], [36, 9, 6], [37, 9, 14], [37, 8, 13], [38, 8, 16], [38, 7, 20], [40, 6, 83], [41, 5, 56], [41, 4, 53], [43, 2, 55], [46, 0, 101], [46, -1, 101], [47, -1, 28], [47, -2, 28], [48, -2, 29], [48, -3, 29], [49, -3, 30], [49, -4, 30], [59, -14, 8], [60, -14, 17], [60, -15, 15], [61, -15, 18], [61, -16, 4], [62, -16, 1], [62, -17, 135], [63, -17, 241], [63, -18, 136], [64, -18, 134], [64, -19, 243], [65, -19, 203], [65, -20, 135], [66, -20, 136], [66, -21, 134], [67, -21, 133], [68, -22, 101], [68, -23, 101], [69, -23, 28], [69, -24, 28], [70, -24, 29], [70, -25, 29], [71, -25, 30], [71, -26, 30], [37, 10, 8], [38, 10, 17], [38, 9, 15], [39, 9, 18], [39, 8, 4], [40, 8, 1], [41, 7, 85], [41, 6, 84], [42, 6, 86], [45, 3, 132], [45, 2, 131], [46, 2, 101], [46, 1, 101], [47, 1, 28], [47, 0, 28], [48, 0, 29], [48, -1, 29], [49, -1, 30], [49, -2, 30], [62, -14, 19], [62, -15, 7], [63, -15, 2], [63, -16, 1], [64, -16, 1], [64, -17, 241], [65, -17, 241], [65, -18, 138], [66, -18, 206], [66, -19, 242], [67, -19, 134], [67, -20, 136], [68, -20, 101], [68, -21, 101], [69, -21, 28], [69, -22, 28], [70, -22, 29], [70, -23, 29], [71, -23, 30], [71, -24, 30], [40, 10, 19], [40, 9, 7], [41, 9, 2], [41, 8, 1], [42, 8, 1], [42, 7, 87], [45, 5, 132], [45, 4, 132], [46, 4, 101], [46, 3, 101], [47, 3, 28], [47, 2, 28], [48, 2, 29], [48, 1, 29], [49, 1, 30], [49, 0, 30], [63, -14, 9], [64, -14, 5], [64, -15, 2], [65, -15, 2], [65, -16, 3], [66, -16, 4], [66, -17, 241], [67, -17, 241], [67, -18, 244], [68, -18, 101], [68, -19, 101], [69, -19, 28], [69, -20, 28], [70, -20, 29], [70, -21, 29], [71, -21, 30], [71, -22, 30], [41, 10, 9], [42, 9, 2], [43, 9, 2], [43, 8, 3], [44, 8, 4], [45, 7, 132], [45, 6, 132], [46, 6, 101], [46, 5, 101], [47, 5, 28], [47, 4, 28], [48, 4, 29], [48, 3, 29], [49, 3, 30], [49, 2, 30], [65, -14, 5], [66, -14, 5], [66, -15, 6], [67, -15, 7], [67, -16, 1], [68, -16, 1], [68, -17, 101], [69, -17, 28], [69, -18, 28], [70, -18, 29], [70, -19, 29], [71, -19, 30], [71, -20, 30], [43, 10, 5], [44, 10, 5], [44, 9, 6], [45, 9, 7], [45, 8, 1], [46, 8, 1], [46, 7, 101], [47, 7, 28], [47, 6, 28], [48, 6, 29], [48, 5, 29], [49, 5, 30], [49, 4, 30], [67, -14, 8], [68, -14, 9], [68, -15, 2], [69, -15, 2], [69, -16, 62], [70, -16, 29], [70, -17, 29], [71, -17, 30], [71, -18, 30], [45, 10, 8], [46, 10, 9], [46, 9, 2], [47, 9, 2], [47, 8, 62], [48, 8, 29], [48, 7, 29], [49, 7, 30], [49, 6, 30], [69, -14, 5], [70, -14, 5], [70, -15, 63], [71, -15, 30], [71, -16, 30], [47, 10, 5], [48, 10, 5], [48, 9, 63], [49, 9, 30], [49, 8, 30], [71, -14, 64], [49, 10, 64], [79, 3, 131], [87, -5, 260], [79, 4, 132], [80, 4, 134], [80, 3, 133], [87, -4, 261], [88, -4, 263], [71, 15, 252], [80, 5, 134], [81, 5, 134], [81, 4, 133], [88, -2, 39], [88, -3, 48], [89, -3, 172], [89, -4, 170], [58, 30, 21], [61, 27, 215], [61, 26, 218], [62, 26, 216], [70, 18, 251], [70, 17, 252], [71, 17, 252], [71, 16, 253], [72, 16, 256], [72, 15, 254], [73, 15, 101], [73, 14, 0], [79, 8, 4], [80, 8, 1], [81, 6, 134], [82, 6, 138], [82, 5, 137], [89, -1, 39], [89, -2, 39], [90, -2, 176], [93, -5, 101], [93, -6, 101], [94, -6, 108], [59, 31, 21], [59, 30, 4], [60, 30, 1], [61, 29, 151], [61, 28, 150], [62, 28, 152], [62, 27, 217], [70, 20, 218], [70, 19, 255], [71, 19, 252], [71, 18, 253], [72, 18, 256], [72, 17, 254], [73, 17, 101], [73, 16, 101], [74, 16, 28], [74, 15, 108], [80, 9, 7], [81, 9, 2], [81, 8, 1], [82, 8, 1], [82, 7, 138], [88, 2, 77], [88, 1, 82], [90, -1, 39], [93, -3, 101], [93, -4, 101], [94, -4, 28], [94, -5, 28], [95, -5, 109], [60, 32, 21], [60, 31, 7], [61, 31, 2], [61, 30, 1], [62, 30, 3], [62, 29, 153], [63, 29, 20], [70, 21, 215], [71, 21, 253], [71, 20, 253], [72, 20, 256], [72, 19, 254], [73, 19, 101], [73, 18, 101], [74, 18, 28], [74, 17, 28], [75, 17, 29], [75, 16, 109], [81, 10, 9], [82, 10, 5], [82, 9, 2], [83, 9, 2], [83, 8, 3], [84, 8, 12], [84, 7, 20], [89, 3, 79], [89, 2, 78], [90, 2, 80], [93, -1, 101], [93, -2, 101], [94, -2, 28], [94, -3, 28], [95, -3, 29], [95, -4, 29], [96, -4, 110], [61, 32, 9], [62, 32, 5], [62, 31, 2], [63, 31, 6], [63, 30, 12], [64, 30, 13], [71, 23, 251], [71, 22, 255], [72, 22, 252], [72, 21, 257], [73, 21, 101], [73, 20, 101], [74, 20, 28], [74, 19, 28], [75, 19, 29], [75, 18, 29], [76, 18, 30], [76, 17, 110], [83, 10, 5], [84, 10, 5], [84, 9, 6], [85, 9, 14], [85, 8, 13], [86, 8, 16], [86, 7, 20], [90, 3, 81], [91, 3, 48], [91, 2, 47], [92, 2, 49], [93, 1, 101], [93, 0, 101], [94, 0, 28], [94, -1, 28], [95, -1, 29], [95, -2, 29], [96, -2, 30], [96, -3, 30], [63, 32, 5], [64, 32, 8], [64, 31, 14], [65, 31, 15], [66, 30, 16], [66, 29, 20], [72, 24, 255], [72, 23, 253], [73, 23, 101], [73, 22, 101], [74, 22, 28], [74, 21, 28], [75, 21, 29], [75, 20, 29], [76, 20, 30], [76, 19, 30], [85, 10, 8], [86, 10, 17], [86, 9, 15], [87, 9, 18], [87, 8, 4], [88, 8, 1], [91, 4, 288], [93, 3, 101], [93, 2, 101], [94, 2, 28], [94, 1, 28], [95, 1, 29], [95, 0, 29], [96, 0, 30], [96, -1, 30], [65, 32, 17], [67, 31, 18], [67, 30, 4], [68, 30, 1], [72, 25, 258], [73, 25, 101], [73, 24, 101], [74, 24, 28], [74, 23, 28], [75, 23, 29], [75, 22, 29], [76, 22, 30], [76, 21, 30], [88, 10, 19], [88, 9, 7], [89, 9, 2], [89, 8, 1], [90, 8, 3], [93, 5, 101], [93, 4, 101], [94, 4, 28], [94, 3, 28], [95, 3, 29], [95, 2, 29], [96, 2, 30], [96, 1, 30], [68, 32, 19], [68, 31, 7], [69, 31, 2], [69, 30, 1], [70, 30, 3], [73, 27, 101], [73, 26, 101], [74, 26, 28], [74, 25, 28], [75, 25, 29], [75, 24, 29], [76, 24, 30], [76, 23, 30], [89, 10, 9], [90, 10, 5], [90, 9, 2], [91, 9, 6], [91, 8, 4], [92, 8, 1], [93, 7, 101], [93, 6, 101], [94, 6, 28], [94, 5, 28], [95, 5, 29], [95, 4, 29], [96, 4, 30], [96, 3, 30], [69, 32, 9], [70, 32, 5], [70, 31, 2], [71, 31, 6], [71, 30, 4], [72, 30, 1], [73, 29, 101], [73, 28, 101], [74, 28, 28], [74, 27, 28], [75, 27, 29], [75, 26, 29], [76, 26, 30], [76, 25, 30], [91, 10, 5], [92, 10, 8], [92, 9, 7], [93, 9, 2], [93, 8, 1], [94, 8, 62], [94, 7, 28], [95, 7, 29], [95, 6, 29], [96, 6, 30], [96, 5, 30], [71, 32, 5], [72, 32, 8], [72, 31, 7], [73, 31, 2], [73, 30, 1], [74, 30, 62], [74, 29, 28], [75, 29, 29], [75, 28, 29], [76, 28, 30], [76, 27, 30], [93, 10, 9], [94, 10, 5], [94, 9, 2], [95, 9, 63], [95, 8, 29], [96, 8, 30], [96, 7, 30], [73, 32, 9], [74, 32, 5], [74, 31, 2], [75, 31, 63], [75, 30, 29], [76, 30, 30], [76, 29, 30], [95, 10, 5], [96, 10, 64], [96, 9, 30], [75, 32, 5], [76, 32, 64], [76, 31, 30], [109, 17, 170], [109, 16, 169], [110, 16, 171], [101, 27, 246], [109, 18, 172], [110, 18, 174], [110, 17, 173], [111, 17, 173], [111, 16, 171], [84, 46, 29], [84, 45, 29], [101, 29, 4], [101, 28, 247], [102, 28, 248], [110, 19, 176], [111, 19, 194], [111, 18, 193], [115, 15, 101], [85, 47, 308], [85, 46, 306], [86, 46, 307], [88, 44, 120], [88, 43, 119], [102, 30, 7], [102, 29, 1], [103, 29, 1], [103, 28, 164], [111, 20, 183], [112, 20, 187], [112, 19, 196], [115, 17, 101], [115, 16, 101], [116, 16, 28], [116, 15, 108], [83, 51, 140], [83, 50, 139], [84, 50, 133], [85, 49, 305], [85, 48, 304], [86, 48, 309], [86, 47, 293], [87, 46, 294], [88, 45, 122], [89, 45, 125], [103, 31, 9], [103, 30, 2], [104, 30, 2], [104, 29, 1], [105, 29, 3], [106, 28, 20], [109, 25, 48], [109, 24, 213], [110, 24, 214], [113, 20, 190], [115, 19, 101], [115, 18, 101], [116, 18, 28], [116, 17, 28], [117, 17, 29], [117, 16, 109], [84, 52, 134], [84, 51, 134], [85, 51, 133], [86, 49, 297], [92, 44, 120], [92, 43, 119], [93, 43, 121], [104, 31, 5], [105, 31, 5], [105, 30, 2], [106, 30, 6], [106, 29, 12], [107, 29, 13], [108, 28, 20], [109, 27, 83], [109, 26, 50], [110, 26, 53], [110, 25, 51], [111, 25, 54], [111, 24, 52], [112, 24, 113], [115, 21, 101], [115, 20, 101], [116, 20, 28], [116, 19, 28], [117, 19, 29], [117, 18, 29], [118, 18, 30], [118, 17, 110], [83, 55, 108], [85, 53, 134], [85, 52, 134], [86, 52, 137], [92, 45, 122], [93, 45, 125], [93, 44, 123], [97, 41, 101], [97, 40, 101], [98, 40, 108], [106, 31, 5], [107, 31, 8], [107, 30, 14], [108, 30, 15], [108, 29, 16], [109, 29, 4], [110, 28, 85], [110, 27, 84], [111, 27, 86], [111, 26, 57], [112, 26, 115], [112, 25, 114], [113, 25, 116], [115, 23, 101], [115, 22, 101], [116, 22, 28], [116, 21, 28], [117, 21, 29], [117, 20, 29], [118, 20, 30], [118, 19, 30], [84, 56, 109], [84, 55, 1], [85, 55, 1], [86, 54, 138], [86, 53, 137], [96, 44, 149], [96, 43, 148], [97, 43, 101], [97, 42, 101], [98, 42, 28], [98, 41, 28], [99, 41, 109], [108, 31, 17], [109, 30, 18], [110, 30, 7], [110, 29, 1], [111, 29, 1], [111, 28, 87], [113, 26, 117], [115, 25, 101], [115, 24, 101], [116, 24, 28], [116, 23, 28], [117, 23, 29], [117, 22, 29], [118, 22, 30], [118, 21, 30], [85, 57, 110], [85, 56, 2], [86, 56, 2], [86, 55, 1], [87, 55, 3], [88, 54, 20], [92, 50, 48], [92, 49, 47], [93, 49, 49], [97, 45, 101], [97, 44, 101], [98, 44, 28], [98, 43, 28], [99, 43, 29], [99, 42, 29], [100, 42, 110], [110, 31, 19], [111, 31, 9], [111, 30, 2], [112, 30, 2], [112, 29, 3], [113, 29, 4], [115, 27, 101], [115, 26, 101], [116, 26, 28], [116, 25, 28], [117, 25, 29], [117, 24, 29], [118, 24, 30], [118, 23, 30], [85, 59, 215], [85, 58, 218], [86, 58, 216], [86, 57, 5], [87, 57, 5], [87, 56, 2], [88, 56, 6], [88, 55, 12], [89, 55, 13], [90, 54, 20], [92, 52, 112], [92, 51, 288], [93, 51, 290], [93, 50, 51], [94, 50, 291], [94, 49, 289], [97, 47, 101], [97, 46, 101], [98, 46, 28], [98, 45, 28], [99, 45, 29], [99, 44, 29], [100, 44, 30], [100, 43, 30], [112, 31, 5], [113, 31, 5], [113, 30, 6], [114, 30, 7], [114, 29, 1], [115, 29, 1], [115, 28, 101], [116, 28, 28], [116, 27, 28], [117, 27, 29], [117, 26, 29], [118, 26, 30], [118, 25, 30], [86, 59, 217], [88, 57, 5], [89, 57, 8], [89, 56, 14], [90, 56, 15], [90, 55, 16], [91, 55, 4], [94, 51, 292], [96, 50, 132], [96, 49, 131], [97, 49, 101], [97, 48, 101], [98, 48, 28], [98, 47, 28], [99, 47, 29], [99, 46, 29], [100, 46, 30], [100, 45, 30], [114, 31, 8], [115, 31, 9], [115, 30, 2], [116, 30, 2], [116, 29, 62], [117, 29, 29], [117, 28, 29], [118, 28, 30], [118, 27, 30], [90, 57, 17], [91, 56, 18], [92, 56, 7], [92, 55, 1], [93, 55, 1], [96, 52, 132], [96, 51, 132], [97, 51, 101], [97, 50, 101], [98, 50, 28], [98, 49, 28], [99, 49, 29], [99, 48, 29], [100, 48, 30], [100, 47, 30], [116, 31, 5], [117, 31, 5], [117, 30, 63], [118, 30, 30], [118, 29, 30], [92, 57, 19], [93, 57, 9], [93, 56, 2], [94, 56, 2], [94, 55, 3], [95, 55, 4], [96, 54, 132], [96, 53, 132], [97, 53, 101], [97, 52, 101], [98, 52, 28], [98, 51, 28], [99, 51, 29], [99, 50, 29], [100, 50, 30], [100, 49, 30], [118, 31, 64], [94, 57, 5], [95, 57, 5], [95, 56, 6], [96, 56, 7], [96, 55, 1], [97, 55, 1], [97, 54, 101], [98, 54, 28], [98, 53, 28], [99, 53, 29], [99, 52, 29], [100, 52, 30], [100, 51, 30], [96, 57, 8], [97, 57, 9], [97, 56, 2], [98, 56, 2], [98, 55, 62], [99, 55, 29], [99, 54, 29], [100, 54, 30], [100, 53, 30], [98, 57, 5], [99, 57, 5], [99, 56, 63], [100, 56, 30], [100, 55, 30], [100, 57, 64]],
		//sort barrierList and occlusionList to accelerate the searching speed
		check_obstacle:function(searchElement,from_index=0){
			for(var i=from_index;i<this.barrierList.length;i++){
				if(this.barrierList[i][0]==searchElement[0]&&this.barrierList[i][1]==searchElement[1])
					return i;
			}
			return -1;
		},
		check_occlusion:function(searchElement,from_index=0){
			for(var i=from_index;i<this.occlusionList.length;i++){
				if(this.occlusionList[i][0]==searchElement[0]&&this.occlusionList[i][1]==searchElement[1])
					return this.occlusionList[i][2];
			}
			return -1;
		},
		init:function(){
				this.spriteSheet = imageLoader.load('images/'+this.name+'_sprite.png');
		},
		show_occlusion_drawing_routine:function(coordinate_x,coordinate_y,map_index){
				map_x_offset=map_index%10;
				map_y_offset=Math.floor(map_index/10);
				[x_center,y_center]=game.toGameCoordinate([coordinate_x,coordinate_y]);
				game.foreground_ctx.drawImage(this.spriteSheet,this.pixelWidth*map_x_offset,this.pixelHeight*map_y_offset,this.pixelWidth,this.pixelHeight,
				x_center-this.pixelWidth/2,y_center-this.pixelHeight/2,this.pixelWidth,this.pixelHeight);
		},
		show_occlusion:function(object){
			var map_index=this.check_occlusion([object.coordinate.x,object.coordinate.y]);
			if(map_index>0){
				this.show_occlusion_drawing_routine(object.coordinate.x,object.coordinate.y,map_index);
			}
			map_index=this.check_occlusion([object.coordinate.x-1,object.coordinate.y]);
			if(map_index>0){
				this.show_occlusion_drawing_routine(object.coordinate.x-1,object.coordinate.y,map_index);
			}
			map_index=this.check_occlusion([object.coordinate.x,object.coordinate.y-1]);
			if(map_index>0){
				this.show_occlusion_drawing_routine(object.coordinate.x,object.coordinate.y-1,map_index);
			}
			map_index=this.check_occlusion([object.coordinate.x-1,object.coordinate.y-1]);
			if(map_index>0){
				this.show_occlusion_drawing_routine(object.coordinate.x-1,object.coordinate.y-1,map_index);
			}
		}
	}
	var	imageLoader = {
	 loaded:true,
	 loadedImages:0,
	 totalImages:0,
	 load:function(url){
		 this.totalImages++;
		 this.loaded = false;
		 var image = new Image();
		 image.src = url;
		 image.onload = function(){
			imageLoader.loadedImages++;
			if(imageLoader.loadedImages === imageLoader.totalImages){
				imageLoader.loaded = true;
				}
			}
		 return image;
	 }
	}

	var protagonist={
			name:"protagonist",
			pixelWidth:22,
			pixelHeight:50,
			pixelOffsetX:0,
			pixelOffsetY:50,
			spriteImages:{
			down:0,
			left:3,
			up:6,
			right:9			
			},
			coordinate:{x:39,y:7},
			player_last_coordinate:{x:39,y:7},
			player_direction:"down",
			is_moving:false,
			player_current_frame:0,//[0,1,2]
			init:function(){
				this.spriteSheet = imageLoader.load('images/'+this.name+'.png');
			},
			update_pos:function(delta_x,delta_y,new_direction){
				if(map.check_obstacle([this.coordinate.x+delta_x,this.coordinate.y+delta_y])>-1)
					return;
				
				this.player_last_coordinate={x:this.coordinate.x,y:this.coordinate.y};
				this.is_moving=true;
				this.coordinate.x+=delta_x;
				this.coordinate.y+=delta_y;	
				this.player_direction=new_direction;		
				//setTimeout(protagonist.update_pos_frame,800);
			},
			update_pos_frame:function(){
				if(protagonist.is_moving){
					protagonist.player_current_frame=(protagonist.player_current_frame+1)%3;
					if(protagonist.player_current_frame==0){
						protagonist.is_moving=false;
					}
					else{
					//	setTimeout(protagonist.update_pos_frame,800);
						//		protagonist.update_pos_frame();
					}
				}
			},
			draw:function(){
				//use box to locate the sprite
				//clear the previous front convas context should be done before calling this function
				var currentOffset=this.spriteImages[this.player_direction]+this.player_current_frame;
				if(this.player_current_frame==1){
				[x_center,y_center]=game.toGameCoordinate(this.player_last_coordinate);
				}
				else{
				[x_center,y_center]=game.toGameCoordinate(this.coordinate);
				}
				//parameter:img,split_pos_x,split_pos_y,split_width;split_height;
				//pos_x_canvas,pos_y_canvas,scaling_x,scaling_y
				game.foreground_ctx.strokeRect(x_center-this.pixelWidth/2,y_center-this.pixelHeight+4,this.pixelWidth,this.pixelHeight);
				game.foreground_ctx.drawImage(this.spriteSheet,this.pixelWidth*currentOffset,0,this.pixelWidth,this.pixelHeight,
				x_center-this.pixelWidth/2,y_center-this.pixelHeight+4,this.pixelWidth,this.pixelHeight);
				map.show_occlusion(this);
				//then show the occlusion effect
			},
	}
	var game={
	animationTimeout:100,
	viewportWidth:0,
	viewportHeight:0,
	gridsize:24,
	panningThreshold:20, // Distance from edge of canvas at which panning starts
	panningSpeed:1,
	refreshBackground:true,
	running:true,
	items:[],
	mapHeight:2064,
	mapWidth:2064,
	offsetX:300,
	offsetY:200,
	mapBorderHiddenOffset:0,
	handlePanning:function(){
	[x_c,y_c]=game.toGameCoordinate(protagonist.coordinate,true);
	if(this.offsetX!=x_c-160){
		this.refreshBackground=true;
	this.offsetX=x_c-160;
	this.offsetY=y_c-100;
	}
	
    },
	drawingLoop:function(){

		if(!imageLoader.loaded){
			//foreground_ctx show loading image here
			setTimeout(game.drawingLoop,400);
			return;}
		game.handlePanning();
		if (game.refreshBackground){
			$("#canvas").css("background-position","-"+String(game.offsetX)+"px "+"-"+String(game.offsetY)+"px");
			//console.log(game.offsetX,game.offsetY);
			game.refreshBackground = false;
		}
		game.foreground_ctx.clearRect(0,0,game.viewportWidth,game.viewportHeight);
		protagonist.update_pos_frame();
		protagonist.draw();
		game.drawDiamond(game.toGameCoordinate(protagonist.coordinate));
		if (game.running){
			//requestAnimationFrame(game.drawingLoop);
			setTimeout(game.drawingLoop,200);
		}
	},
	animationLoop:function(){
		for(var i=0;i<game.items.length;i++)
				game.items[i].animate();
	},
	processKeyboardEvent:function(ev){
		switch(ev.which){
			case 38://up
				protagonist.update_pos(0,-1,"up");
			break;
			case 40://key_board_down
				protagonist.update_pos(0,1,"down");
			break;
			case 39://right
				protagonist.update_pos(1,0,"right");
			break;
			case 37://left
				protagonist.update_pos(-1,0,"left");
			break;
			default:break;
		}
	},
	init:function(){
		game.$canvas=$("#canvas");//back canvas,jquery object
		game.ctx = game.$canvas[0].getContext("2d");  
		game.foreground_canvas=$("#foreground_canvas")[0];
		game.foreground_ctx=game.foreground_canvas.getContext("2d");
		game.viewportWidth=game.$canvas[0].width;
		game.viewportHeight=game.$canvas[0].height;
		game.foreground_ctx.strokeStyle="#00ff00";
		game.ctx.strokeStyle="#ff0000";
		game.foreground_ctx.fillStyle='rgba(0,0,0,1)';//100%opacity
		protagonist.init();
		map.init();
		$(document).keydown(function(ev){
				game.processKeyboardEvent(ev);
		});
	},
	toGameCoordinate:function(xyPos,isAbsolute){
		if (xyPos.x){
			tmp=xyPos;
			[x,y]=[tmp.x,tmp.y];
		}
		else{
		[x,y]=xyPos;
		}
		new_offsetX=game.offsetX;
		new_offsetY=game.offsetY;
		if(isAbsolute){
		new_offsetX=0;
		new_offsetY=0;
		}
		else{
			new_offsetX=game.offsetX;
			new_offsetY=game.offsetY;
		}
			x_center=(x-y)*16-new_offsetX;
			y_center=(x+y)*8-new_offsetY;
		return [x_center,y_center];
	},
	getLeftCoordinate:function(object_pointer){
		if(object_pointer.coordinate.h==0){
				return [object_pointer.coordinate.x-1,object_pointer.coordinate.y-1,1-object_pointer.coordinate.h];
			}
			else{
				return [object_pointer.coordinate.x,object_pointer.coordinate.y,1-object_pointer.coordinate.h];
			}
	},
	drawDiamond:function(gameCoordinate,isClip){
		if(isClip){
		[x_center,y_center]=gameCoordinate;
		game.ctx.beginPath();
		game.foreground_ctx.moveTo(x_center+16,y_center);
		game.foreground_ctx.lineTo(x_center,y_center-8);
		game.foreground_ctx.lineTo(x_center-16,y_center);
		game.foreground_ctx.lineTo(x_center,y_center+8);
		game.foreground_ctx.closePath();
		}
		else{
		[x_center,y_center]=gameCoordinate;
		game.foreground_ctx.beginPath();
		game.foreground_ctx.moveTo(x_center+16,y_center);
		game.foreground_ctx.lineTo(x_center,y_center-8);
		game.foreground_ctx.lineTo(x_center-16,y_center);
		game.foreground_ctx.lineTo(x_center,y_center+8);
		game.foreground_ctx.closePath();
		game.foreground_ctx.stroke();
		}
	}	
	}
	



	
	game.init();
	game.drawingLoop();
	//game.animationLoop();
	//game.animationInterval = setInterval(game.animationLoop,game.animationTimeout);
});


