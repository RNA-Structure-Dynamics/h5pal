$(document).ready(function () {
	var json_event_list=[{"y": 808, "x": 528}, {"y": 632, "x": 688}, {"y": 672, "x": 736}, {"y": 392, "x": 1168}, {"y": 280, "x": 1264}, {"y": 400, "x": 1280}, {"y": 320, "x": 1472}, {"y": 616, "x": 656}, {"y": 296, "x": 1392}, {"y": 280, "x": 1392}, {"y": 304, "x": 1344}, {"y": 304, "x": 1344}, {"y": 1136, "x": 1216}, {"y": 1072, "x": 1536}, {"y": 1048, "x": 1488}, {"y": 1104, "x": 1280}, {"y": 1088, "x": 1344}, {"y": 408, "x": 432}, {"y": 1296, "x": 704}, {"y": 1080, "x": 720}, {"y": 1152, "x": 672}, {"y": 1120, "x": 512}, {"y": 1136, "x": 480}, {"y": 1160, "x": 432}, {"y": 296, "x": 560}, {"y": 1120, "x": 1376}, {"y": 1048, "x": 1328}, {"y": 264, "x": 1296}, {"y": 264, "x": 1296}, {"y": 264, "x": 1296}, {"y": 320, "x": 768}, {"y": 376, "x": 1328}];
	var map={
		name:"Yu_Hang_inns_seperate_rooms",
		pixelWidth:32,
		pixelHeight:15,
		pixelOffsetX:10,
		pixelOffsetY:31,
		barrierList:[[33, -5], [33, -6], [34, -6], [33, -3], [33, -4], [34, -5], [35, -6], [36, -6], [56, -26], [56, -27], [57, -27], [33, -1], [33, -2], [34, -2], [37, -5], [37, -6], [38, -6], [56, -24], [56, -25], [57, -25], [57, -26], [58, -26], [58, -27], [59, -27], [33, 1], [33, 0], [34, -1], [39, -5], [39, -6], [40, -6], [56, -22], [56, -23], [58, -25], [59, -25], [59, -26], [60, -26], [60, -27], [61, -27], [33, 3], [33, 2], [41, -6], [42, -6], [56, -20], [56, -21], [57, -22], [60, -25], [62, -27], [63, -27], [33, 5], [33, 4], [43, -5], [43, -6], [44, -6], [56, -18], [56, -19], [58, -21], [64, -27], [65, -27], [33, 7], [33, 6], [43, -4], [44, -4], [44, -5], [45, -5], [45, -6], [46, -6], [56, -16], [56, -17], [58, -19], [66, -26], [66, -27], [67, -27], [33, 9], [33, 8], [34, 8], [39, 3], [41, 1], [45, -4], [46, -4], [46, -5], [47, -6], [48, -6], [56, -14], [56, -15], [57, -15], [66, -25], [67, -25], [67, -26], [68, -26], [68, -27], [69, -27], [33, 10], [34, 10], [34, 9], [41, 3], [49, -5], [49, -6], [57, -14], [58, -14], [67, -23], [68, -25], [69, -25], [69, -26], [70, -26], [70, -27], [71, -27], [35, 10], [36, 10], [41, 5], [41, 4], [42, 4], [42, 3], [43, 3], [49, -3], [49, -4], [59, -14], [60, -14], [65, -19], [70, -24], [70, -25], [71, -25], [71, -26], [37, 10], [38, 10], [42, 5], [43, 5], [43, 4], [49, -1], [49, -2], [60, -12], [60, -13], [65, -17], [65, -18], [70, -23], [71, -23], [71, -24], [38, 12], [38, 11], [42, 7], [49, 1], [49, 0], [61, -12], [62, -12], [63, -13], [63, -14], [64, -14], [65, -15], [65, -16], [68, -18], [68, -19], [71, -21], [71, -22], [39, 12], [40, 12], [41, 11], [41, 10], [42, 10], [49, 3], [49, 2], [63, -12], [65, -14], [66, -14], [66, -15], [67, -15], [68, -17], [71, -19], [71, -20], [41, 12], [43, 10], [44, 10], [48, 6], [48, 5], [49, 5], [49, 4], [67, -14], [68, -14], [68, -15], [69, -15], [71, -17], [71, -18], [45, 10], [46, 10], [48, 8], [48, 7], [49, 7], [49, 6], [69, -14], [70, -14], [70, -15], [71, -15], [71, -16], [47, 10], [48, 10], [48, 9], [49, 9], [49, 8], [71, -14], [49, 10], [57, 15], [58, 14], [57, 17], [57, 16], [59, 14], [60, 14], [57, 19], [57, 18], [59, 17], [59, 16], [60, 16], [61, 14], [62, 14], [57, 21], [57, 20], [59, 19], [59, 18], [60, 17], [61, 17], [61, 16], [62, 16], [63, 14], [64, 14], [81, -3], [57, 23], [57, 22], [59, 21], [59, 20], [60, 20], [60, 19], [61, 19], [62, 18], [62, 17], [63, 17], [63, 16], [64, 16], [65, 14], [66, 14], [81, -1], [81, -2], [82, -2], [82, -3], [83, -3], [57, 25], [57, 24], [59, 23], [59, 22], [60, 22], [60, 21], [61, 21], [61, 20], [62, 20], [62, 19], [63, 19], [63, 18], [64, 18], [64, 17], [65, 17], [65, 16], [66, 16], [67, 14], [68, 14], [81, 1], [81, 0], [82, -1], [84, -3], [85, -3], [57, 27], [57, 26], [59, 25], [59, 24], [61, 23], [61, 22], [62, 22], [62, 21], [63, 21], [63, 20], [64, 20], [64, 19], [65, 19], [65, 18], [66, 18], [67, 16], [68, 16], [69, 14], [70, 14], [81, 3], [81, 2], [86, -3], [87, -3], [57, 29], [57, 28], [59, 27], [59, 26], [61, 25], [61, 24], [62, 24], [62, 23], [63, 23], [63, 22], [64, 22], [64, 21], [65, 21], [65, 20], [66, 19], [67, 18], [68, 18], [69, 16], [70, 16], [71, 15], [71, 14], [72, 14], [81, 5], [81, 4], [88, -3], [89, -3], [58, 30], [59, 29], [59, 28], [61, 27], [61, 26], [62, 25], [63, 25], [63, 24], [65, 22], [69, 18], [70, 18], [70, 17], [71, 17], [71, 16], [72, 16], [72, 15], [73, 15], [73, 14], [81, 7], [81, 6], [82, 6], [90, -2], [90, -3], [91, -3], [59, 31], [59, 30], [61, 29], [61, 28], [62, 27], [71, 18], [72, 18], [72, 17], [73, 17], [73, 16], [81, 9], [81, 8], [82, 8], [82, 7], [90, -1], [91, -1], [91, -2], [92, -2], [92, -3], [93, -3], [60, 32], [60, 31], [61, 31], [61, 30], [62, 30], [62, 29], [71, 21], [72, 20], [72, 19], [73, 19], [73, 18], [74, 18], [81, 10], [82, 10], [82, 9], [92, -1], [93, -1], [93, -2], [94, -2], [94, -3], [95, -3], [61, 32], [62, 32], [62, 31], [63, 31], [63, 30], [72, 21], [73, 21], [73, 20], [74, 20], [74, 19], [75, 19], [75, 18], [76, 18], [83, 10], [84, 10], [90, 3], [94, -1], [95, -1], [95, -2], [96, -2], [96, -3], [63, 32], [64, 32], [64, 31], [73, 23], [73, 22], [74, 22], [74, 21], [75, 21], [75, 20], [76, 20], [76, 19], [85, 10], [86, 10], [92, 4], [92, 3], [93, 3], [96, 0], [96, -1], [65, 33], [65, 32], [74, 24], [74, 23], [75, 23], [75, 22], [76, 22], [76, 21], [86, 12], [86, 11], [92, 5], [93, 5], [93, 4], [94, 4], [94, 3], [95, 3], [96, 2], [96, 1], [65, 34], [66, 34], [74, 25], [75, 25], [75, 24], [76, 24], [76, 23], [87, 12], [88, 12], [89, 11], [89, 10], [90, 10], [94, 5], [95, 5], [95, 4], [96, 4], [96, 3], [67, 34], [68, 34], [69, 33], [69, 32], [70, 32], [75, 27], [75, 26], [76, 26], [76, 25], [89, 12], [91, 10], [92, 10], [96, 6], [96, 5], [69, 34], [71, 32], [72, 32], [76, 28], [76, 27], [93, 10], [94, 10], [96, 8], [96, 7], [73, 32], [74, 32], [76, 30], [76, 29], [95, 10], [96, 10], [96, 9], [75, 32], [76, 32], [76, 31], [103, 19], [103, 18], [104, 18], [103, 21], [103, 20], [104, 19], [105, 18], [106, 18], [103, 23], [103, 22], [107, 18], [108, 18], [85, 43], [103, 25], [103, 24], [109, 18], [110, 18], [85, 45], [85, 44], [86, 44], [86, 43], [87, 43], [103, 27], [103, 26], [111, 18], [112, 18], [85, 47], [85, 46], [87, 44], [88, 43], [89, 43], [103, 29], [103, 28], [112, 20], [112, 19], [113, 19], [113, 18], [114, 18], [85, 49], [85, 48], [86, 48], [86, 47], [87, 47], [89, 45], [89, 44], [90, 44], [90, 43], [91, 43], [103, 31], [103, 30], [104, 30], [113, 20], [114, 20], [114, 19], [115, 19], [115, 18], [116, 18], [85, 51], [85, 50], [86, 50], [86, 49], [87, 49], [87, 48], [90, 45], [91, 45], [91, 44], [92, 43], [93, 43], [104, 31], [105, 31], [110, 26], [110, 25], [111, 25], [115, 20], [117, 18], [118, 18], [85, 53], [85, 52], [87, 50], [93, 45], [93, 44], [94, 44], [94, 43], [95, 43], [106, 31], [107, 31], [110, 27], [111, 27], [111, 26], [112, 26], [112, 25], [118, 20], [118, 19], [85, 55], [85, 54], [86, 54], [86, 53], [94, 45], [95, 45], [95, 44], [96, 43], [97, 43], [108, 32], [108, 31], [111, 28], [112, 27], [113, 26], [118, 22], [118, 21], [85, 57], [85, 56], [86, 56], [86, 55], [97, 44], [98, 44], [98, 43], [99, 43], [108, 33], [109, 33], [111, 31], [118, 24], [118, 23], [85, 59], [85, 58], [86, 57], [87, 57], [93, 51], [93, 50], [94, 50], [99, 44], [100, 44], [100, 43], [110, 33], [111, 33], [111, 32], [112, 31], [113, 31], [118, 26], [118, 25], [85, 61], [85, 60], [86, 59], [88, 57], [89, 57], [93, 52], [94, 52], [94, 51], [95, 51], [95, 50], [100, 46], [100, 45], [114, 31], [115, 31], [118, 28], [118, 27], [86, 61], [87, 61], [90, 57], [95, 52], [100, 48], [100, 47], [116, 31], [117, 31], [118, 30], [118, 29], [88, 61], [89, 61], [93, 57], [100, 50], [100, 49], [118, 31], [90, 61], [91, 61], [94, 57], [95, 57], [99, 53], [99, 52], [100, 52], [100, 51], [92, 61], [93, 61], [96, 57], [97, 57], [99, 55], [99, 54], [100, 54], [100, 53], [94, 61], [95, 61], [98, 57], [99, 57], [99, 56], [100, 56], [100, 55], [96, 61], [97, 61], [100, 57], [101, 57], [98, 61], [99, 61], [102, 57], [103, 57], [100, 61], [101, 61], [102, 61], [103, 61]],
		occlusionList:[[31, -5, [131], [7]], [31, 5, [131], [7]], [31, 8, [4], [5]], [32, -4, [204], [5]], [32, 6, [134], [5]], [32, 8, [1], [5]], [32, 9, [7], [3]], [32, -5, [202], [6]], [32, 5, [133], [6]], [33, -3, [207], [3]], [33, 7, [134], [3]], [33, 9, [2], [3]], [33, 8, [1], [5]], [33, 10, [9], [1]], [33, -4, [133], [4]], [33, 6, [133], [4]], [34, -2, [138], [1]], [34, 8, [1], [5]], [34, 10, [5], [1]], [34, 9, [2], [3]], [34, -3, [137], [2]], [34, 7, [137], [2]], [35, 9, [2], [3]], [35, 8, [3], [5]], [35, 10, [5], [1]], [35, -7, [42], [5]], [35, -6, [43], [4]], [36, 8, [12], [5]], [36, 10, [5], [1]], [36, 9, [6], [3]], [36, -6, [45], [3]], [36, -7, [44], [4]], [36, 7, [20], [6]], [37, 9, [14], [3]], [37, 10, [8], [1]], [37, -7, [88], [5]], [37, -5, [46], [1]], [37, -6, [93], [4]], [37, 1, [82], [5]], [37, 2, [77], [4]], [37, 8, [13], [4]], [38, 10, [17], [1]], [38, -6, [90], [3]], [38, -5, [94], [2]], [38, 2, [78], [3]], [38, 3, [79], [2]], [38, 8, [16], [6]], [38, 7, [20], [6]], [38, 9, [15], [2]], [39, 8, [4], [5]], [39, -5, [92], [1]], [39, -1, [71], [5]], [39, 1, [211], [5]], [39, 3, [81], [1]], [39, 2, [80], [2]], [39, 9, [18], [4]], [40, -8, [169], [7]], [40, -7, [170], [7]], [40, 2, [47, 212], [3, 3]], [40, 3, [48, 213], [3, 3]], [40, 8, [1], [5]], [40, 9, [7], [3]], [40, -6, [172], [6]], [40, 0, [73], [3]], [40, -1, [72], [4]], [40, 1, [74], [2]], [40, 4, [50], [3]], [40, 6, [83], [4]], [40, 10, [19], [2]], [41, -7, [173], [7]], [41, -8, [171], [7]], [41, -6, [174], [5]], [41, 3, [51, 214], [3, 3]], [41, 2, [49], [3]], [41, 9, [2], [3]], [41, 8, [1], [5]], [41, 10, [9], [1]], [41, -5, [176], [4]], [41, 1, [76], [1]], [41, 0, [75], [2]], [41, 5, [56], [1]], [41, 4, [53], [3]], [41, 7, [85], [2]], [41, 6, [84], [3]], [42, -8, [171], [7]], [42, -6, [177], [2]], [42, -7, [173], [7]], [42, -5, [180], [2]], [42, 8, [1], [5]], [42, 9, [2], [3]], [42, -4, [183], [2]], [42, 2, [52], [3]], [42, 6, [86], [2]], [42, 7, [87], [1]], [43, 9, [2], [3]], [43, 8, [3], [5]], [43, 10, [5], [1]], [43, 2, [55], [2]], [44, 8, [4], [5]], [44, 10, [5], [1]], [44, 9, [6], [3]], [45, 3, [132], [7]], [45, 2, [131], [7]], [45, 5, [132], [7]], [45, 4, [132], [7]], [45, 7, [132], [7]], [45, 6, [132], [7]], [45, 9, [7], [3]], [45, 8, [1], [5]], [45, 10, [8], [1]], [46, -8, [101], [7]], [46, -9, [101], [7]], [46, -6, [101], [7]], [46, -7, [101], [7]], [46, -4, [101], [7]], [46, -5, [101], [7]], [46, -2, [101], [7]], [46, -3, [101], [7]], [46, 0, [101], [7]], [46, -1, [101], [7]], [46, 2, [101], [7]], [46, 1, [101], [7]], [46, 4, [101], [7]], [46, 3, [101], [7]], [46, 6, [101], [7]], [46, 5, [101], [7]], [46, 8, [1], [5]], [46, 7, [101], [7]], [46, 10, [9], [1]], [46, 9, [2], [3]], [47, -7, [28], [5]], [47, -8, [28], [5]], [47, -5, [28], [5]], [47, -6, [28], [5]], [47, -3, [28], [5]], [47, -4, [28], [5]], [47, -1, [28], [5]], [47, -2, [28], [5]], [47, 1, [28], [5]], [47, 0, [28], [5]], [47, 3, [28], [5]], [47, 2, [28], [5]], [47, 5, [28], [5]], [47, 4, [28], [5]], [47, 7, [28], [5]], [47, 6, [28], [5]], [47, 9, [2], [3]], [47, 8, [28, 62], [5, 5]], [47, 10, [5], [1]], [48, -6, [29], [3]], [48, -7, [29], [3]], [48, -4, [29], [3]], [48, -5, [29], [3]], [48, -2, [29], [3]], [48, -3, [29], [3]], [48, 0, [29], [3]], [48, -1, [29], [3]], [48, 2, [29], [3]], [48, 1, [29], [3]], [48, 4, [29], [3]], [48, 3, [29], [3]], [48, 6, [29], [3]], [48, 5, [29], [3]], [48, 8, [29], [3]], [48, 7, [29], [3]], [48, 10, [5], [1]], [48, 9, [29, 63], [3, 3]], [49, -5, [30], [1]], [49, -6, [30], [1]], [49, -3, [30], [1]], [49, -4, [30], [1]], [49, -1, [30], [1]], [49, -2, [30], [1]], [49, 1, [30], [1]], [49, 0, [30], [1]], [49, 3, [30], [1]], [49, 2, [30], [1]], [49, 5, [30], [1]], [49, 4, [30], [1]], [49, 7, [30], [1]], [49, 6, [30], [1]], [49, 9, [30], [1]], [49, 8, [30], [1]], [49, 10, [30, 64], [1, 1]], [54, -18, [131], [7]], [54, -16, [4], [5]], [54, -17, [135], [7]], [54, -24, [33], [6]], [54, -25, [32], [7]], [55, -17, [204], [5]], [55, -15, [7], [3]], [55, -16, [1], [5]], [55, -25, [34], [6]], [55, -23, [36], [4]], [55, -24, [35], [5]], [55, -18, [202], [6]], [56, -23, [38], [3]], [56, -16, [1], [5]], [56, -14, [9], [1]], [56, -15, [2], [3]], [56, -24, [37], [4]], [56, -22, [39], [2]], [56, -17, [133], [4]], [57, -22, [41, 240], [1, 3]], [57, -15, [2], [3]], [57, -16, [3], [5]], [57, -14, [5], [1]], [57, -23, [40], [2]], [57, -21, [236], [2]], [57, -19, [233], [2]], [57, -20, [232], [3]], [58, -16, [12], [5]], [58, -14, [5], [1]], [58, -15, [6], [3]], [58, 30, [3, 21], [6, 6]], [58, -22, [237], [2]], [58, -20, [234], [2]], [58, -21, [238], [1]], [58, -19, [235], [1]], [58, -17, [20], [6]], [59, -15, [14], [3]], [59, -14, [8], [1]], [59, 31, [6, 21], [4, 4]], [59, 30, [4], [5]], [59, -16, [13], [4]], [60, -14, [17], [1]], [60, 30, [1], [5]], [60, 32, [8, 21], [2, 2]], [60, 31, [7], [3]], [60, -16, [16], [6]], [60, -17, [20], [6]], [60, -15, [15], [2]], [61, -16, [4], [5]], [61, 31, [2], [3]], [61, 30, [1], [5]], [61, 32, [9], [1]], [61, -15, [18], [4]], [61, 27, [215], [2]], [61, 26, [218], [3]], [61, 29, [151], [3]], [61, 28, [150], [3]], [62, -22, [131], [7]], [62, -20, [132], [7]], [62, -21, [132], [7]], [62, -18, [132], [7]], [62, -19, [132], [7]], [62, -16, [1], [5]], [62, -17, [135], [7]], [62, -15, [7], [3]], [62, 30, [3], [5]], [62, 32, [5], [1]], [62, 31, [2], [3]], [62, -14, [19], [2]], [62, 26, [216], [2]], [62, 28, [152], [2]], [62, 27, [217], [1]], [62, 29, [153], [3]], [63, -21, [134], [5]], [63, -19, [134], [5]], [63, -20, [134], [5]], [63, -17, [241], [7]], [63, -18, [136], [5]], [63, -15, [2], [3]], [63, -16, [1], [5]], [63, -14, [9], [1]], [63, 31, [6], [3]], [63, 30, [12], [5]], [63, 32, [5], [1]], [63, -22, [133], [5]], [63, 29, [20], [6]], [64, -20, [134], [3]], [64, -18, [134], [3]], [64, -19, [243], [3]], [64, -16, [1], [5]], [64, -17, [241], [7]], [64, -14, [5], [1]], [64, -15, [2], [3]], [64, 32, [8], [1]], [64, 31, [14], [3]], [64, -28, [219], [5]], [64, -27, [220], [4]], [64, -21, [133], [3]], [64, 30, [13], [4]], [65, -21, [132], [7]], [65, -22, [131], [7]], [65, -19, [245, 203], [1, 6]], [65, -20, [135], [7]], [65, -17, [241], [7]], [65, -18, [138], [1]], [65, -15, [2], [3]], [65, -16, [3], [5]], [65, -14, [5], [1]], [65, 32, [17], [1]], [65, -27, [222], [3]], [65, -28, [221], [4]], [65, -25, [230], [2]], [65, -26, [224], [3]], [65, -24, [83], [4]], [65, 31, [15], [2]], [66, -26, [226], [3]], [66, -27, [24, 225], [3, 3]], [66, -20, [136], [5]], [66, -21, [134], [5]], [66, -19, [242], [5]], [66, -16, [4], [5]], [66, -17, [241], [7]], [66, -14, [5], [1]], [66, -15, [6], [3]], [66, -29, [211], [9]], [66, -24, [84], [3]], [66, -25, [227], [1]], [66, -22, [133], [6]], [66, -23, [85], [2]], [66, -18, [206], [4]], [66, 30, [16], [6]], [66, 29, [20], [6]], [67, -29, [48], [7]], [67, -27, [48, 231], [7, 7]], [67, -28, [48, 212], [7, 7]], [67, -26, [48], [7]], [67, -19, [134], [3]], [67, -20, [136], [3]], [67, -17, [241], [7]], [67, -18, [244], [3]], [67, -15, [7], [3]], [67, -16, [1], [5]], [67, -14, [8], [1]], [67, 30, [4], [5]], [67, -25, [203], [6]], [67, -23, [87], [1]], [67, -24, [86], [2]], [67, -21, [133], [4]], [67, 31, [18], [4]], [68, -30, [101], [7]], [68, -28, [101], [7]], [68, -29, [101], [7]], [68, -26, [101, 229], [7, 7]], [68, -27, [101, 228], [7, 7]], [68, -24, [101], [7]], [68, -25, [101], [7]], [68, -22, [101], [7]], [68, -23, [101], [7]], [68, -20, [101], [7]], [68, -21, [101], [7]], [68, -18, [101], [7]], [68, -19, [101], [7]], [68, -16, [1], [5]], [68, -17, [101], [7]], [68, -14, [9], [1]], [68, -15, [2], [3]], [68, 30, [1], [5]], [68, 31, [7], [3]], [68, 32, [19], [2]], [69, -29, [28], [5]], [69, -30, [0, 108], [6, 6]], [69, -27, [28], [5]], [69, -28, [28], [5]], [69, -25, [28], [5]], [69, -26, [28], [5]], [69, -23, [28], [5]], [69, -24, [28], [5]], [69, -21, [28], [5]], [69, -22, [28], [5]], [69, -19, [28], [5]], [69, -20, [28], [5]], [69, -17, [28], [5]], [69, -18, [28], [5]], [69, -15, [2], [3]], [69, -16, [28, 62], [5, 5]], [69, -14, [5], [1]], [69, 31, [2], [3]], [69, 30, [1], [5]], [69, 32, [9], [1]], [70, -28, [29], [3]], [70, -29, [0, 109], [4, 4]], [70, -26, [29], [3]], [70, -27, [29], [3]], [70, -24, [29], [3]], [70, -25, [29], [3]], [70, -22, [29], [3]], [70, -23, [29], [3]], [70, -20, [29], [3]], [70, -21, [29], [3]], [70, -18, [29], [3]], [70, -19, [29], [3]], [70, -16, [29], [3]], [70, -17, [29], [3]], [70, -14, [5], [1]], [70, -15, [29, 63], [3, 3]], [70, 18, [253, 251], [7, 7]], [70, 30, [3], [5]], [70, 32, [5], [1]], [70, 31, [2], [3]], [70, 17, [252], [7]], [70, 20, [218], [3]], [70, 19, [255], [7]], [70, 21, [215], [2]], [71, -27, [30], [1]], [71, -28, [0, 110], [2, 2]], [71, -25, [30], [1]], [71, -26, [30], [1]], [71, -23, [30], [1]], [71, -24, [30], [1]], [71, -21, [30], [1]], [71, -22, [30], [1]], [71, -19, [30], [1]], [71, -20, [30], [1]], [71, -17, [30], [1]], [71, -18, [30], [1]], [71, -15, [30], [1]], [71, -16, [30], [1]], [71, -14, [30, 64], [1, 1]], [71, 15, [101, 252], [9, 9]], [71, 17, [253, 252], [7, 7]], [71, 16, [253], [8]], [71, 19, [257, 252], [7, 7]], [71, 18, [253], [7]], [71, 21, [253], [6]], [71, 20, [253], [6]], [71, 31, [6], [3]], [71, 30, [4], [5]], [71, 32, [5], [1]], [71, 23, [251], [4]], [71, 22, [255], [5]], [72, 16, [256], [9]], [72, 15, [101, 254], [9, 9]], [72, 18, [256], [9]], [72, 17, [257, 254], [9, 9]], [72, 20, [256], [9]], [72, 19, [257, 254], [9, 9]], [72, 22, [257, 252], [9, 9]], [72, 21, [257], [9]], [72, 23, [253], [5]], [72, 30, [1], [5]], [72, 32, [8], [1]], [72, 31, [7], [3]], [72, 24, [255], [3]], [72, 25, [258], [2]], [73, 15, [101], [7]], [73, 14, [0], [8]], [73, 17, [101], [7]], [73, 16, [101], [7]], [73, 19, [101], [7]], [73, 18, [101], [7]], [73, 21, [101], [7]], [73, 20, [101], [7]], [73, 23, [101], [7]], [73, 22, [101], [7]], [73, 25, [101], [7]], [73, 24, [101], [7]], [73, 27, [101], [7]], [73, 26, [101], [7]], [73, 29, [101], [7]], [73, 28, [101], [7]], [73, 31, [2], [3]], [73, 30, [1], [5]], [73, 32, [9], [1]], [74, 16, [28], [5]], [74, 15, [0, 108], [6, 5]], [74, 18, [28], [5]], [74, 17, [28], [5]], [74, 20, [28], [5]], [74, 19, [28], [5]], [74, 22, [28], [5]], [74, 21, [28], [5]], [74, 24, [28], [5]], [74, 23, [28], [5]], [74, 26, [28], [5]], [74, 25, [28], [5]], [74, 28, [28], [5]], [74, 27, [28], [5]], [74, 30, [28, 62], [5, 5]], [74, 29, [28], [5]], [74, 32, [5], [1]], [74, 31, [2], [3]], [75, 17, [29], [3]], [75, 16, [0, 109], [4, 3]], [75, 19, [29], [3]], [75, 18, [29], [3]], [75, 21, [29], [3]], [75, 20, [29], [3]], [75, 23, [29], [3]], [75, 22, [29], [3]], [75, 25, [29], [3]], [75, 24, [29], [3]], [75, 27, [29], [3]], [75, 26, [29], [3]], [75, 29, [29], [3]], [75, 28, [29], [3]], [75, 31, [29, 63], [3, 3]], [75, 30, [29], [3]], [75, 32, [5], [1]], [76, 18, [30], [1]], [76, 17, [0, 110], [2, 1]], [76, 20, [30], [1]], [76, 19, [30], [1]], [76, 22, [30], [1]], [76, 21, [30], [1]], [76, 24, [30], [1]], [76, 23, [30], [1]], [76, 26, [30], [1]], [76, 25, [30], [1]], [76, 28, [30], [1]], [76, 27, [30], [1]], [76, 30, [30], [1]], [76, 29, [30], [1]], [76, 32, [30, 64], [1, 1]], [76, 31, [30], [1]], [79, 3, [131], [7]], [79, 4, [132], [7]], [79, 8, [4], [5]], [80, 4, [134], [5]], [80, 5, [134], [5]], [80, 8, [1], [5]], [80, 9, [7], [3]], [80, 3, [133], [6]], [81, 5, [134], [3]], [81, 6, [134], [3]], [81, 9, [2], [3]], [81, 8, [1], [5]], [81, 10, [9], [1]], [81, 4, [133], [4]], [82, 6, [138], [1]], [82, 8, [1], [5]], [82, 7, [138], [1]], [82, 10, [5], [1]], [82, 9, [2], [3]], [82, 5, [137], [2]], [83, 9, [2], [3]], [83, 8, [3], [5]], [83, 10, [5], [1]], [83, 51, [132, 140], [7, 7]], [83, 50, [131, 139], [7, 7]], [83, 55, [4, 108], [5, 5]], [84, 8, [12], [5]], [84, 10, [5], [1]], [84, 9, [6], [3]], [84, 46, [29], [1]], [84, 45, [29], [1]], [84, 52, [134], [5]], [84, 51, [134], [5]], [84, 56, [7, 109], [3, 3]], [84, 55, [1], [5]], [84, 7, [20], [6]], [84, 50, [133], [6]], [85, 9, [14], [3]], [85, 10, [8], [1]], [85, 47, [295, 308], [3, 3]], [85, 46, [295, 306], [3, 3]], [85, 49, [295, 305], [3, 3]], [85, 48, [295, 304], [3, 3]], [85, 53, [134], [3]], [85, 52, [134], [3]], [85, 55, [1], [5]], [85, 57, [9, 110], [1, 1]], [85, 56, [2], [3]], [85, 8, [13], [4]], [85, 51, [133], [4]], [85, 59, [215], [2]], [85, 58, [218], [3]], [86, 10, [17], [1]], [86, 46, [293, 307], [3, 3]], [86, 48, [293, 309], [3, 3]], [86, 47, [293], [3]], [86, 49, [297], [3]], [86, 54, [138], [1]], [86, 53, [138, 137], [1, 1]], [86, 56, [2], [3]], [86, 55, [1], [5]], [86, 57, [5], [1]], [86, 8, [16], [6]], [86, 7, [20], [6]], [86, 9, [15], [2]], [86, 52, [137], [2]], [86, 58, [216], [2]], [86, 59, [217], [1]], [87, 8, [4], [5]], [87, 55, [3], [5]], [87, 57, [5], [1]], [87, 56, [2], [3]], [87, -5, [260], [7]], [87, -4, [261], [6]], [87, 9, [18], [4]], [87, 46, [294], [2]], [88, -4, [48, 263], [5, 5]], [88, -3, [48], [5]], [88, 8, [1], [5]], [88, 9, [7], [3]], [88, 43, [119], [3]], [88, 56, [6], [3]], [88, 55, [12], [5]], [88, 57, [5], [1]], [88, -2, [39], [4]], [88, 2, [77], [4]], [88, 1, [82], [5]], [88, 10, [19], [2]], [88, 44, [120], [3]], [88, 45, [122], [2]], [88, 54, [20], [6]], [89, -3, [47, 172], [5, 5]], [89, -4, [170], [7]], [89, -2, [41, 39], [3, 3]], [89, 9, [2], [3]], [89, 8, [1], [5]], [89, 10, [9], [1]], [89, 57, [8], [1]], [89, 56, [14], [3]], [89, -1, [39], [2]], [89, 3, [79], [2]], [89, 2, [78], [3]], [89, 45, [125], [1]], [89, 55, [13], [4]], [90, -2, [41, 176], [3, 3]], [90, -1, [41, 39], [1, 1]], [90, 8, [3], [5]], [90, 10, [5], [1]], [90, 9, [2], [3]], [90, 57, [17], [1]], [90, 2, [80], [2]], [90, 3, [81], [1]], [90, 54, [20], [6]], [90, 56, [15], [2]], [90, 55, [16], [6]], [91, 3, [48], [3]], [91, 2, [47], [4]], [91, 9, [6], [3]], [91, 8, [4], [5]], [91, 10, [5], [1]], [91, 55, [4], [5]], [91, 4, [288], [2]], [91, 56, [18], [4]], [92, 2, [49], [3]], [92, 8, [1], [5]], [92, 10, [8], [1]], [92, 9, [7], [3]], [92, 43, [119], [3]], [92, 50, [48], [3]], [92, 49, [47], [3]], [92, 56, [7], [3]], [92, 55, [1], [5]], [92, 44, [120], [3]], [92, 45, [122], [2]], [92, 52, [112], [2]], [92, 51, [288], [3]], [92, 57, [19], [2]], [93, -5, [101], [7]], [93, -6, [101], [7]], [93, -3, [101], [7]], [93, -4, [101], [7]], [93, -1, [101], [7]], [93, -2, [101], [7]], [93, 1, [101], [7]], [93, 0, [101], [7]], [93, 3, [101], [7]], [93, 2, [101], [7]], [93, 5, [101], [7]], [93, 4, [101], [7]], [93, 7, [101], [7]], [93, 6, [101], [7]], [93, 9, [2], [3]], [93, 8, [1], [5]], [93, 10, [9], [1]], [93, 43, [121], [3]], [93, 44, [123], [3]], [93, 49, [49], [3]], [93, 50, [51], [3]], [93, 55, [1], [5]], [93, 57, [9], [1]], [93, 56, [2], [3]], [93, 45, [125], [1]], [93, 51, [290], [3]], [94, -6, [0, 108], [6, 6]], [94, -4, [28], [5]], [94, -5, [28], [5]], [94, -2, [28], [5]], [94, -3, [28], [5]], [94, 0, [28], [5]], [94, -1, [28], [5]], [94, 2, [28], [5]], [94, 1, [28], [6]], [94, 4, [28], [5]], [94, 3, [28], [5]], [94, 6, [28], [5]], [94, 5, [28], [5]], [94, 8, [28, 62], [5, 5]], [94, 7, [28], [5]], [94, 10, [5], [1]], [94, 9, [2], [3]], [94, 56, [2], [3]], [94, 55, [3], [5]], [94, 57, [5], [1]], [94, 50, [291], [3]], [94, 49, [289], [3]], [94, 51, [292], [3]], [95, -5, [0, 109], [4, 4]], [95, -3, [29], [3]], [95, -4, [29], [3]], [95, -1, [29], [3]], [95, -2, [29], [3]], [95, 1, [29], [3]], [95, 0, [29], [3]], [95, 3, [29], [3]], [95, 2, [29], [3]], [95, 5, [29], [2]], [95, 4, [29], [3]], [95, 7, [29], [3]], [95, 6, [29], [3]], [95, 9, [29, 63], [3, 3]], [95, 8, [29], [3]], [95, 10, [5], [1]], [95, 55, [4], [5]], [95, 57, [5], [1]], [95, 56, [6], [3]], [96, -4, [0, 110], [2, 2]], [96, -2, [30], [1]], [96, -3, [30], [1]], [96, 0, [30], [1]], [96, -1, [30], [1]], [96, 2, [30], [1]], [96, 1, [30], [1]], [96, 4, [30], [1]], [96, 3, [30], [1]], [96, 6, [30], [1]], [96, 5, [30], [1]], [96, 8, [30], [1]], [96, 7, [30], [1]], [96, 10, [30, 64], [1, 1]], [96, 9, [30], [1]], [96, 43, [148], [3]], [96, 50, [132], [7]], [96, 49, [131], [7]], [96, 52, [132], [7]], [96, 51, [132], [7]], [96, 54, [132], [7]], [96, 53, [132], [7]], [96, 56, [7], [3]], [96, 55, [1], [5]], [96, 57, [8], [1]], [96, 44, [149], [2]], [97, 41, [101], [7]], [97, 40, [101], [7]], [97, 43, [101], [7]], [97, 42, [101], [7]], [97, 45, [101], [7]], [97, 44, [101], [7]], [97, 47, [101], [7]], [97, 46, [101], [7]], [97, 49, [101], [7]], [97, 48, [101], [7]], [97, 51, [101], [7]], [97, 50, [101], [7]], [97, 53, [101], [7]], [97, 52, [101], [7]], [97, 55, [1], [5]], [97, 54, [101], [7]], [97, 57, [9], [1]], [97, 56, [2], [3]], [98, 40, [0, 108], [6, 6]], [98, 42, [28], [5]], [98, 41, [28], [5]], [98, 44, [28], [5]], [98, 43, [28], [5]], [98, 46, [28], [5]], [98, 45, [28], [5]], [98, 48, [28], [5]], [98, 47, [28], [5]], [98, 50, [28], [5]], [98, 49, [28], [5]], [98, 52, [28], [5]], [98, 51, [28], [5]], [98, 54, [28], [5]], [98, 53, [28], [5]], [98, 56, [2], [3]], [98, 55, [28, 62], [5, 5]], [98, 57, [5], [1]], [99, 41, [0, 109], [4, 4]], [99, 43, [29], [3]], [99, 42, [29], [3]], [99, 45, [29], [3]], [99, 44, [29], [3]], [99, 47, [29], [3]], [99, 46, [29], [3]], [99, 49, [29], [3]], [99, 48, [29], [3]], [99, 51, [29], [3]], [99, 50, [29], [3]], [99, 53, [29], [3]], [99, 52, [29], [3]], [99, 55, [29], [3]], [99, 54, [29], [3]], [99, 57, [5], [1]], [99, 56, [29, 63], [3, 3]], [100, 42, [0, 110], [2, 2]], [100, 44, [30], [1]], [100, 43, [30], [1]], [100, 46, [30], [1]], [100, 45, [30], [1]], [100, 48, [30], [1]], [100, 47, [30], [1]], [100, 50, [30], [1]], [100, 49, [30], [1]], [100, 52, [30], [1]], [100, 51, [30], [1]], [100, 54, [30], [1]], [100, 53, [30], [1]], [100, 56, [30], [1]], [100, 55, [30], [1]], [100, 57, [30, 64], [1, 1]], [101, 29, [4], [5]], [101, 27, [246], [7]], [101, 28, [247], [6]], [102, 30, [7], [3]], [102, 29, [1], [5]], [102, 28, [248], [5]], [103, 29, [1], [5]], [103, 31, [9], [1]], [103, 30, [2], [3]], [103, 28, [164], [4]], [104, 30, [2], [3]], [104, 29, [1], [5]], [104, 31, [5], [1]], [105, 29, [3], [5]], [105, 31, [5], [1]], [105, 30, [2], [3]], [106, 30, [6], [3]], [106, 29, [12], [5]], [106, 31, [5], [1]], [106, 28, [20], [6]], [107, 31, [8], [1]], [107, 30, [14], [3]], [107, 29, [13], [4]], [108, 31, [17], [1]], [108, 28, [20], [6]], [108, 30, [15], [2]], [108, 29, [16], [6]], [109, 17, [170], [7]], [109, 16, [169], [7]], [109, 25, [48], [3]], [109, 24, [47, 213], [3, 3]], [109, 29, [4], [5]], [109, 18, [172], [6]], [109, 27, [83], [4]], [109, 26, [50], [3]], [109, 30, [18], [4]], [110, 16, [171], [7]], [110, 18, [174], [5]], [110, 17, [173], [7]], [110, 24, [49, 214], [3, 3]], [110, 25, [51], [3]], [110, 30, [7], [3]], [110, 29, [1], [5]], [110, 19, [176], [4]], [110, 26, [53], [3]], [110, 28, [85], [2]], [110, 27, [84], [3]], [110, 31, [19], [2]], [111, 17, [173], [7]], [111, 16, [171], [7]], [111, 19, [194], [3]], [111, 18, [193], [5]], [111, 29, [1], [5]], [111, 31, [9], [1]], [111, 30, [2], [3]], [111, 20, [183], [2]], [111, 25, [54], [3]], [111, 24, [52], [3]], [111, 27, [86], [2]], [111, 26, [57], [3]], [111, 28, [87], [1]], [112, 20, [187], [1]], [112, 19, [196], [3]], [112, 30, [2], [3]], [112, 29, [3], [5]], [112, 31, [5], [1]], [112, 24, [113], [4]], [112, 26, [115], [2]], [112, 25, [114], [3]], [113, 20, [190], [1]], [113, 29, [4], [5]], [113, 31, [5], [1]], [113, 30, [6], [3]], [113, 25, [116], [2]], [113, 26, [117], [1]], [114, 30, [7], [3]], [114, 29, [1], [5]], [114, 31, [8], [1]], [115, 15, [101], [7]], [115, 17, [101], [7]], [115, 16, [101], [7]], [115, 19, [101], [7]], [115, 18, [101], [7]], [115, 21, [101], [7]], [115, 20, [101], [7]], [115, 23, [101], [7]], [115, 22, [101], [7]], [115, 25, [101], [7]], [115, 24, [101], [7]], [115, 27, [101], [7]], [115, 26, [101], [7]], [115, 29, [1], [5]], [115, 28, [101], [7]], [115, 31, [9], [1]], [115, 30, [2], [3]], [116, 16, [28], [5]], [116, 15, [0, 108], [6, 6]], [116, 18, [28], [5]], [116, 17, [28], [5]], [116, 20, [28], [5]], [116, 19, [28], [5]], [116, 22, [28], [5]], [116, 21, [28], [5]], [116, 24, [28], [5]], [116, 23, [28], [5]], [116, 26, [28], [5]], [116, 25, [28], [5]], [116, 28, [28], [5]], [116, 27, [28], [5]], [116, 30, [2], [3]], [116, 29, [28, 62], [5, 5]], [116, 31, [5], [1]], [117, 17, [29], [3]], [117, 16, [0, 109], [4, 4]], [117, 19, [29], [3]], [117, 18, [29], [3]], [117, 21, [29], [3]], [117, 20, [29], [3]], [117, 23, [29], [3]], [117, 22, [29], [3]], [117, 25, [29], [3]], [117, 24, [29], [3]], [117, 27, [29], [3]], [117, 26, [29], [3]], [117, 29, [29], [3]], [117, 28, [29], [3]], [117, 31, [5], [1]], [117, 30, [29, 63], [3, 3]], [118, 18, [30], [1]], [118, 17, [0, 110], [2, 2]], [118, 20, [30], [1]], [118, 19, [30], [1]], [118, 22, [30], [1]], [118, 21, [30], [1]], [118, 24, [30], [1]], [118, 23, [30], [1]], [118, 26, [30], [1]], [118, 25, [30], [1]], [118, 28, [30], [1]], [118, 27, [30], [1]], [118, 30, [30], [1]], [118, 29, [30], [1]], [118, 31, [30, 64], [1, 1]]],
		//sort barrierList and occlusionList to accelerate the searching speed
		check_obstacle:function(searchElement,from_index=0){
			for(var i=from_index;i<this.barrierList.length;i++){
				if(this.barrierList[i][0]==searchElement[0]&&this.barrierList[i][1]==searchElement[1])
					return i;
			}
			return -1;
		},
		check_occlusion:function(searchElement,index_offset,from_index=0){
			var r1=0;
			var r2=this.occlusionList.length-1;
			if(searchElement[0]<this.occlusionList[0][0] || searchElement[0]>this.occlusionList[r2][0])
				return undefined;
			var max_loop=12
			while(r2-r1>1 && max_loop>0){
				var tmp=(r2+r1)>>1;
				if(searchElement[0]<this.occlusionList[tmp][0]){
					r2=tmp;
				}
				else{
					r1=tmp;
				}
				max_loop-=1;
			}
			while(this.occlusionList[r1][0]==searchElement[0] && r1>=0){
				if(this.occlusionList[r1][1]==searchElement[1]){
					if(this.occlusionList[r1][3][0]>index_offset)
						return this.occlusionList[r1][2];
					return undefined;
				}
				r1-=1;
			}
			while(this.occlusionList[r2][0]==searchElement[0] && r2<=this.occlusionList.length-1){
				if(this.occlusionList[r2][1]==searchElement[1]){
					if(this.occlusionList[r2][3][0]>index_offset)
						return this.occlusionList[r2][2];
					return undefined;
				}
				r2+=1;
			}
			return undefined;
		},
		init:function(){
				this.spriteSheet = imageLoader.load('images/'+this.name+'_sprite.png');
		},
		show_occlusion_drawing_routine:function(coordinate_x,coordinate_y,map_index){
				[x_center,y_center]=game.toGameCoordinate([coordinate_x,coordinate_y]);
				var map_x_offset=map_index[0]%10;
				var map_y_offset=Math.floor(map_index[0]/10);
				game.foreground_ctx.drawImage(this.spriteSheet,this.pixelWidth*map_x_offset,this.pixelHeight*map_y_offset,this.pixelWidth,this.pixelHeight,
				x_center+1-this.pixelWidth/2,y_center-this.pixelHeight/2,this.pixelWidth,this.pixelHeight);
				//game.drawDiamond([x_center+1,y_center])
				//notice the x_center+1 offset
				if(map_index[1]){
				map_x_offset=map_index[1]%10;
				map_y_offset=Math.floor(map_index[1]/10);
				game.foreground_ctx.drawImage(this.spriteSheet,this.pixelWidth*map_x_offset,this.pixelHeight*map_y_offset,this.pixelWidth,this.pixelHeight,
				x_center+1-this.pixelWidth/2,y_center-(this.pixelHeight)/2,this.pixelWidth,this.pixelHeight);
				}
		},
		check_occlusion_outer:function(coordinate){
			var map_index=this.check_occlusion([coordinate.x,coordinate.y],0);
			if(map_index){
				this.show_occlusion_drawing_routine(coordinate.x,coordinate.y,map_index);
				}
			map_index=this.check_occlusion([coordinate.x-1,coordinate.y],1);
			if(map_index){
				this.show_occlusion_drawing_routine(coordinate.x-1,coordinate.y,map_index);
				}
			map_index=this.check_occlusion([coordinate.x,coordinate.y-1],1);
			if(map_index){
				this.show_occlusion_drawing_routine(coordinate.x,coordinate.y-1,map_index);
			}
			map_index=this.check_occlusion([coordinate.x-1,coordinate.y-1],2);
			if(map_index){
				this.show_occlusion_drawing_routine(coordinate.x-1,coordinate.y-1,map_index);
			}
			map_index=this.check_occlusion([coordinate.x-2,coordinate.y-1],3);
			if(map_index){
				this.show_occlusion_drawing_routine(coordinate.x-2,coordinate.y-1,map_index);
			}
			map_index=this.check_occlusion([coordinate.x-1,coordinate.y-2],3);
			if(map_index){
				this.show_occlusion_drawing_routine(coordinate.x-1,coordinate.y-2,map_index);
			}
			map_index=this.check_occlusion([coordinate.x-2,coordinate.y-2],4);
			if(map_index){
				this.show_occlusion_drawing_routine(coordinate.x-2,coordinate.y-2,map_index);
			}
			map_index=this.check_occlusion([coordinate.x-2,coordinate.y-3],5);
			if(map_index){
				this.show_occlusion_drawing_routine(coordinate.x-2,coordinate.y-3,map_index);
			}
			map_index=this.check_occlusion([coordinate.x-3,coordinate.y-2],5);
			if(map_index){
				this.show_occlusion_drawing_routine(coordinate.x-3,coordinate.y-2,map_index);
			}

			}
	}
	var	imageLoader = {
	 loaded:true,
	 loadedImages:0,
	 totalImages:0,
	 load:function(url){
		 this.totalImages++;
		 this.loaded = false;
		 var image = new Image();
		 image.src = url;
		 image.onload = function(){
			imageLoader.loadedImages++;
			if(imageLoader.loadedImages === imageLoader.totalImages){
				imageLoader.loaded = true;
				}
			}
		 return image;
	 }
	}

	var protagonist={
			name:"protagonist",
			pixelWidth:22,
			pixelHeight:50,
			pixelOffsetX:0,
			pixelOffsetY:50,
			spriteImages:{
			down:0,
			left:3,
			up:6,
			right:9			
			},
			coordinate:{x:41,y:2},
			player_last_coordinate:{x:41,y:2},
			player_direction:"down",
			is_moving:false,
			player_current_frame:0,//[0,1,2]
			init:function(){
				this.spriteSheet = imageLoader.load('images/'+this.name+'.png');
			},
			update_pos:function(delta_x,delta_y,new_direction){
				if(map.check_obstacle([this.coordinate.x+delta_x,this.coordinate.y+delta_y])>-1){
					this.player_direction=new_direction;
					return;
				}
				
				this.player_last_coordinate={x:this.coordinate.x,y:this.coordinate.y};
				this.is_moving=true;
				this.coordinate.x+=delta_x;
				this.coordinate.y+=delta_y;	
				this.player_direction=new_direction;		
				//setTimeout(protagonist.update_pos_frame,800);
			},
			update_pos_frame:function(){
				if(protagonist.is_moving){
					protagonist.player_current_frame=(protagonist.player_current_frame+1)%3;
					if(protagonist.player_current_frame==0){
						protagonist.is_moving=false;
					}
					else{
					//	setTimeout(protagonist.update_pos_frame,800);
						//		protagonist.update_pos_frame();
					}
				}
			},
			draw:function(){
				//use box to locate the sprite
				//clear the previous front convas context should be done before calling this function
				var currentOffset=this.spriteImages[this.player_direction]+this.player_current_frame;
				if(this.player_current_frame==1){
				[x_center,y_center]=game.toGameCoordinate(this.player_last_coordinate);
				}
				else{
				[x_center,y_center]=game.toGameCoordinate(this.coordinate);
				}
				//parameter:img,split_pos_x,split_pos_y,split_width;split_height;
				//pos_x_canvas,pos_y_canvas,scaling_x,scaling_y
				game.foreground_canvas.setAttribute('style','z-index:-1;');
				//game.foreground_ctx.strokeRect(x_center-this.pixelWidth/2,y_center-this.pixelHeight+4,this.pixelWidth,this.pixelHeight);
				game.foreground_ctx.drawImage(this.spriteSheet,this.pixelWidth*currentOffset,0,this.pixelWidth,this.pixelHeight,
				x_center-this.pixelWidth/2,y_center-this.pixelHeight+4,this.pixelWidth,this.pixelHeight);
				if(this.player_current_frame==1){
				map.check_occlusion_outer(this.player_last_coordinate);
				}
				else{
					map.check_occlusion_outer(this.coordinate);
				}
				game.foreground_canvas.setAttribute('style','z-index:1;');
				//then show the occlusion effect
			},
	}
	var game={
	animationTimeout:100,
	viewportWidth:0,
	viewportHeight:0,
	gridsize:24,
	panningThreshold:20, // Distance from edge of canvas at which panning starts
	panningSpeed:1,
	refreshBackground:true,
	running:true,
	items:[],
	mapHeight:2064,
	mapWidth:2064,
	offsetX:300,
	offsetY:200,
	mapBorderHiddenOffset:0,
	handlePanning:function(){
	[x_c,y_c]=game.toGameCoordinate(protagonist.coordinate,true);
	if(this.offsetX!=x_c-160){
		this.refreshBackground=true;
	this.offsetX=x_c-160;
	this.offsetY=y_c-100;
	}
	
    },
	drawingLoop:function(){

		if(!imageLoader.loaded){
			//foreground_ctx show loading image here
			setTimeout(game.drawingLoop,400);
			return;}
		game.handlePanning();
		if (game.refreshBackground){
			$("#canvas").css("background-position","-"+String(game.offsetX)+"px "+"-"+String(game.offsetY)+"px");
			//console.log(game.offsetX,game.offsetY);
			game.refreshBackground = false;
		}
		game.foreground_ctx.clearRect(0,0,game.viewportWidth,game.viewportHeight);
		protagonist.update_pos_frame();
		protagonist.draw();
		//game.drawDiamond(game.toGameCoordinate(protagonist.coordinate));
		if (game.running){
			//requestAnimationFrame(game.drawingLoop);
			setTimeout(game.drawingLoop,200);
		}
	},
	animationLoop:function(){
		for(var i=0;i<game.items.length;i++)
				game.items[i].animate();
	},
	processKeyboardEvent:function(ev){
		switch(ev.which){
			case 38://up
				protagonist.update_pos(0,-1,"up");
			break;
			case 40://key_board_down
				protagonist.update_pos(0,1,"down");
			break;
			case 39://right
				protagonist.update_pos(1,0,"right");
			break;
			case 37://left
				protagonist.update_pos(-1,0,"left");
			break;
			default:break;
		}
	},
	init:function(){
		game.$canvas=$("#canvas");//back canvas,jquery object
		game.ctx = game.$canvas[0].getContext("2d");  
		game.foreground_canvas=$("#foreground_canvas")[0];
		game.foreground_ctx=game.foreground_canvas.getContext("2d");
		game.viewportWidth=game.$canvas[0].width;
		game.viewportHeight=game.$canvas[0].height;
		game.foreground_ctx.strokeStyle="#00ff00";
		game.ctx.strokeStyle="#ff0000";
		game.foreground_ctx.fillStyle='rgba(0,0,0,1)';//100%opacity
		protagonist.init();
		map.init();
		$(document).keydown(function(ev){
				game.processKeyboardEvent(ev);
		});
	},
	toGameCoordinate:function(xyPos,isAbsolute){
		if (xyPos.x){
			tmp=xyPos;
			[x,y]=[tmp.x,tmp.y];
		}
		else{
		[x,y]=xyPos;
		}
		new_offsetX=game.offsetX;
		new_offsetY=game.offsetY;
		if(isAbsolute){
		new_offsetX=0;
		new_offsetY=0;
		}
		else{
			new_offsetX=game.offsetX;
			new_offsetY=game.offsetY;
		}
			x_center=(x-y)*16-new_offsetX;
			y_center=(x+y)*8-new_offsetY;
		return [x_center,y_center];
	},
	getLeftCoordinate:function(object_pointer){
		if(object_pointer.coordinate.h==0){
				return [object_pointer.coordinate.x-1,object_pointer.coordinate.y-1,1-object_pointer.coordinate.h];
			}
			else{
				return [object_pointer.coordinate.x,object_pointer.coordinate.y,1-object_pointer.coordinate.h];
			}
	},
	drawDiamond:function(gameCoordinate,isClip){
		if(isClip){
		[x_center,y_center]=gameCoordinate;
		game.ctx.beginPath();
		game.foreground_ctx.moveTo(x_center+16,y_center);
		game.foreground_ctx.lineTo(x_center,y_center-8);
		game.foreground_ctx.lineTo(x_center-16,y_center);
		game.foreground_ctx.lineTo(x_center,y_center+8);
		game.foreground_ctx.closePath();
		}
		else{
		[x_center,y_center]=gameCoordinate;
		game.foreground_ctx.beginPath();
		game.foreground_ctx.moveTo(x_center+16,y_center);
		game.foreground_ctx.lineTo(x_center,y_center-8);
		game.foreground_ctx.lineTo(x_center-16,y_center);
		game.foreground_ctx.lineTo(x_center,y_center+8);
		game.foreground_ctx.closePath();
		game.foreground_ctx.stroke();
		}
	}	
	}
	



	
	game.init();
	game.drawingLoop();
	//game.animationLoop();
	//game.animationInterval = setInterval(game.animationLoop,game.animationTimeout);
});


